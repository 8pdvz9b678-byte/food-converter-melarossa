<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Food Converter (Melarossa-style)</title>
<style>
  :root {
    --bg:#0b0f14; --card:#111826; --muted:#7f8ea3; --text:#e7eef8; --accent:#66c2ff; --danger:#ff6b6b;
    --border:#1f2a3a;
    --radius:14px;
    --pad:14px;
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif;
  }
  body { margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 60%, #070a0f 100%); color:var(--text); }
  .wrap { max-width:1100px; margin:0 auto; padding:24px 16px 40px; }
  h1 { font-size:20px; margin:0 0 8px; letter-spacing:.2px; }
  .sub { color:var(--muted); font-size:13px; margin-bottom:16px; line-height:1.35; }
  .grid { display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
  @media (max-width: 900px) { .grid{grid-template-columns:1fr;} }
  .card { background:rgba(17,24,38,.92); border:1px solid var(--border); border-radius:var(--radius); padding:var(--pad); box-shadow:0 10px 35px rgba(0,0,0,.35); }
  .card h2 { font-size:14px; margin:0 0 10px; }
  .row { display:grid; grid-template-columns: 1.2fr .55fr .45fr .35fr; gap:10px; align-items:center; margin:10px 0; }
  .row.outputs { grid-template-columns: 1.2fr .55fr .45fr .35fr; }
  .row.head { margin-top:0; color:var(--muted); font-size:12px; }
  select,input { width:100%; background:#0c1320; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 10px; font-size:13px; outline:none; }
  input[type="number"] { appearance:textfield; }
  .btnbar { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  button { background:#0c1320; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:13px; cursor:pointer; }
  button.primary { border-color:rgba(102,194,255,.45); box-shadow:0 0 0 3px rgba(102,194,255,.08) inset; }
  button.danger { border-color:rgba(255,107,107,.45); }
  button:active { transform:translateY(1px); }
  .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0c1320; color:var(--muted); font-size:12px; }
  .pill strong { color:var(--text); font-weight:600; }
  .totals { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0; }
  .warn { color:var(--danger); font-size:12px; margin-top:10px; display:none; line-height:1.35; white-space:pre-line;}
  .muted { color:var(--muted); font-size:12px; }
  .small { font-size:12px; color:var(--muted); }
  .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
  .rightcol { display:flex; flex-direction:column; gap:14px; }
  .result { border-top:1px dashed var(--border); margin-top:12px; padding-top:12px; }
  .kbd { padding:2px 6px; border:1px solid var(--border); border-bottom-color:#0a0f18; border-radius:8px; background:#0c1320; font-size:12px; color:var(--muted); }
  .topline{display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;}
  .mode{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
</style>
</head>
<body>
<div class="wrap">
  <div class="topline">
    <div>
      <h1>Food Converter (Melarossa‑style)</h1>
      <div class="sub">
        Inserisci uno o più alimenti di partenza (INPUT), ottieni il totale equivalente (Eq) e converti in uno o più alimenti di arrivo (OUTPUT) con split percentuali.
        Funziona per <span class="kbd">Carbo</span> (PaneEq), <span class="kbd">Proteine</span> (ProtEq) e <span class="kbd">Latticini</span> (LatteEq).
      </div>
    </div>
    <div class="mode card" style="padding:12px 14px;">
      <div class="small" style="margin-bottom:6px;">Modalità conversione</div>
      <select id="modeSelect"></select>
      <div class="small" style="margin-top:8px;">Suggerimento: tieni Input/Output nella stessa modalità.</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>INPUT (quello che hai)</h2>
      <div class="row head">
        <div>Alimento</div><div>Quantità</div><div>Unità</div><div></div>
      </div>
      <div id="inputs"></div>
      <div class="btnbar">
        <button class="primary" id="addInputBtn">+ Aggiungi input</button>
        <button id="clearInputsBtn" class="danger">Pulisci input</button>
      </div>

      <div class="totals">
        <div class="pill">Totale Eq: <strong id="totalEq">0</strong> <span class="mono" id="eqLabel">PaneEq</span></div>
        <div class="pill">Somma % output: <strong id="pctSum">0</strong>%</div>
      </div>
      <div class="warn" id="warnBox"></div>
    </div>

    <div class="rightcol">
      <div class="card">
        <h2>OUTPUT (in cosa lo trasformi)</h2>
        <div class="row head">
          <div>Alimento target</div><div>Percentuale</div><div>Risultato</div><div></div>
        </div>
        <div id="outputs"></div>
        <div class="btnbar">
          <button class="primary" id="addOutputBtn">+ Aggiungi output</button>
          <button id="normalizeBtn">Normalizza a 100%</button>
          <button id="clearOutputsBtn" class="danger">Pulisci output</button>
        </div>

        <div class="result">
          <div class="muted">Note</div>
          <div class="small" style="margin-top:6px;">
            • <span class="mono">Eq = quantità × fattore</span> (il fattore è quello del tuo database ALIMENTI).<br/>
            • Output: <span class="mono">quantità_target = (Eq_totale × % / 100) ÷ fattore_target</span>.<br/>
            • Unità: per i carbo è in grammi; per proteine/latticini dipende dalla tua scelta (porzioni/uova/g‑ml).
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Dettagli alimento selezionato</h2>
        <div class="small">Clicca un alimento nei menu per vedere fattore e note.</div>
        <div style="margin-top:10px;" class="pill"><span id="foodDetailName">—</span></div>
        <div style="margin-top:10px;" class="small" id="foodDetailBody">—</div>
      </div>
    </div>
  </div>
</div>

<script>
const FOODS = [{"name": "Pane", "category": "Carbo", "base": "PaneEq", "factor": 1.0, "note": "Riferimento", "unitHint": "g"}, {"name": "Pasta secca", "category": "Carbo", "base": "PaneEq", "factor": 1.3, "note": "", "unitHint": "g"}, {"name": "Cous Cous", "category": "Carbo", "base": "PaneEq", "factor": 1.3, "note": "", "unitHint": "g"}, {"name": "Riso", "category": "Carbo", "base": "PaneEq", "factor": 1.3, "note": "", "unitHint": "g"}, {"name": "Polenta", "category": "Carbo", "base": "PaneEq", "factor": 1.3, "note": "", "unitHint": "g"}, {"name": "Farina", "category": "Carbo", "base": "PaneEq", "factor": 1.3, "note": "", "unitHint": "g"}, {"name": "Patate", "category": "Carbo", "base": "PaneEq", "factor": 0.3333, "note": "", "unitHint": "g"}, {"name": "Gnocchi", "category": "Carbo", "base": "PaneEq", "factor": 0.4762, "note": "", "unitHint": "g"}, {"name": "Crackers", "category": "Carbo", "base": "PaneEq", "factor": 2.0, "note": "", "unitHint": "g"}, {"name": "Pane Colazione", "category": "Carbo", "base": "PaneEq", "factor": 1.0, "note": "25 g = 25 PaneEq", "unitHint": "g"}, {"name": "Biscotti Secchi", "category": "Carbo", "base": "PaneEq", "factor": 1.6667, "note": "15 g = 25 PaneEq", "unitHint": "g"}, {"name": "Corn Flakes", "category": "Carbo", "base": "PaneEq", "factor": 1.3889, "note": "18 g = 25 PaneEq", "unitHint": "g"}, {"name": "Fette Biscottate", "category": "Carbo", "base": "PaneEq", "factor": 12.5, "note": "1 fetta = 12,5 PaneEq", "unitHint": "fette"}, {"name": "Carne Rossa", "category": "Proteine", "base": "ProtEq", "factor": 1.0, "note": "porzione piena", "unitHint": "porzioni"}, {"name": "Carne Bianca", "category": "Proteine", "base": "ProtEq", "factor": 1.0, "note": "porzione piena", "unitHint": "porzioni"}, {"name": "Pesce", "category": "Proteine", "base": "ProtEq", "factor": 1.0, "note": "porzione piena", "unitHint": "porzioni"}, {"name": "Affettati magri", "category": "Proteine", "base": "ProtEq", "factor": 0.5, "note": "1 porzione affettato = metà carne", "unitHint": "porzioni"}, {"name": "Affettati grassi", "category": "Proteine", "base": "ProtEq", "factor": 0.5, "note": "1 porzione affettato = metà carne", "unitHint": "porzioni"}, {"name": "Uova", "category": "Proteine", "base": "ProtEq", "factor": 0.5, "note": "2 uova = 1 porzione carne/pesce", "unitHint": "uova"}, {"name": "Latte", "category": "Latticini", "base": "LatteEq", "factor": 1.0, "note": "", "unitHint": "g/ml"}, {"name": "Yogurt", "category": "Latticini", "base": "LatteEq", "factor": 1.0, "note": "", "unitHint": "g/ml"}, {"name": "Mozzarella", "category": "Latticini", "base": "LatteEq", "factor": 1.0, "note": "", "unitHint": "g/ml"}, {"name": "Caciottina Fresca", "category": "Latticini", "base": "LatteEq", "factor": 1.0, "note": "", "unitHint": "g/ml"}, {"name": "Formaggi Freschi", "category": "Latticini", "base": "LatteEq", "factor": 1.0, "note": "", "unitHint": "g/ml"}, {"name": "Ricotta", "category": "Latticini", "base": "LatteEq", "factor": 0.5, "note": "", "unitHint": "g/ml"}, {"name": "Pasta Fresca", "category": "Carbo", "base": "PaneEq", "factor": 2.6, "note": "Pasta fresca = 2× pasta secca", "unitHint": "g"}];

const MODES = [
  { key:'PaneEq', label:'Carbo (PaneEq)', category:'Carbo', eqLabel:'PaneEq' },
  { key:'ProtEq', label:'Proteine (ProtEq)', category:'Proteine', eqLabel:'ProtEq' },
  { key:'LatteEq', label:'Latticini (LatteEq)', category:'Latticini', eqLabel:'LatteEq' },
];

const $ = (id)=>document.getElementById(id);

let state = {
  mode: 'PaneEq',
  inputs: [],
  outputs: [],
};

function foodsForMode(modeKey){
  return FOODS.filter(f=>f.base===modeKey).sort((a,b)=>a.name.localeCompare(b.name,'it'));
}

function unitDefaultFor(food){
  return (food && food.unitHint) ? food.unitHint : 'unità';
}

function renderModeSelect(){
  const sel = $('modeSelect');
  sel.innerHTML = MODES.map(m=>`<option value="${m.key}">${m.label}</option>`).join('');
  sel.value = state.mode;
  sel.addEventListener('change', ()=> {
    state.mode = sel.value;
    // reset outputs selections to avoid cross-mode mismatch
    state.outputs = state.outputs.map(o=>({...o, foodName:''}));
    renderAll();
  });
}

function makeFoodSelect(modeKey, selectedName, onChange){
  const foods = foodsForMode(modeKey);
  const options = ['<option value="">— seleziona —</option>']
    .concat(foods.map(f=>`<option value="${escapeHtml(f.name)}" ${f.name===selectedName?'selected':''}>${escapeHtml(f.name)}</option>`));
  const sel = document.createElement('select');
  sel.innerHTML = options.join('');
  sel.addEventListener('change', ()=> onChange(sel.value));
  return sel;
}

function escapeHtml(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

function findFood(name){
  return FOODS.find(f=>f.name===name);
}

function addInput(){
  state.inputs.push({ foodName:'', qty:0, unit:'' });
  renderAll();
}

function addOutput(){
  state.outputs.push({ foodName:'', pct:0 });
  renderAll();
}

function removeAt(arr, idx){ arr.splice(idx,1); }

function fmt(n){
  if (!isFinite(n)) return '—';
  const x = Math.round(n*1000)/1000;
  return x.toString();
}

function calc(){
  const modeKey = state.mode;
  const eqLabel = (MODES.find(m=>m.key===modeKey)||{}).eqLabel || modeKey;
  $('eqLabel').textContent = eqLabel;

  let totalEq = 0;
  let warnings = [];

  for (const inp of state.inputs){
    if (!inp.foodName) continue;
    const food = findFood(inp.foodName);
    if (!food) continue;
    if (food.base !== modeKey) {
      warnings.push(`Input "${food.name}" è di tipo ${food.base} e non della modalità selezionata (${modeKey}). Non viene conteggiato.`);
      continue;
    }
    const qty = Number(inp.qty) || 0;
    totalEq += qty * Number(food.factor);
  }

  const pctSum = state.outputs.reduce((s,o)=>s+(Number(o.pct)||0),0);
  $('pctSum').textContent = Math.round(pctSum*100)/100;
  $('totalEq').textContent = fmt(totalEq);

  const warnBox = $('warnBox');
  if (warnings.length){
    warnBox.style.display='block';
    warnBox.textContent = warnings.join('\n');
  } else {
    warnBox.style.display='none';
    warnBox.textContent = '';
  }

  // update output results
  const outContainer = $('outputs');
  const outRows = outContainer.querySelectorAll('[data-out-row="1"]');
  outRows.forEach((rowEl, idx)=>{
    const o = state.outputs[idx];
    const resEl = rowEl.querySelector('[data-out-res="1"]');
    if (!resEl) return;
    if (!o.foodName) { resEl.textContent = '—'; return; }
    const food = findFood(o.foodName);
    if (!food) { resEl.textContent = '—'; return; }
    if (food.base !== modeKey) { resEl.textContent = '⚠️'; return; }

    const pct = (Number(o.pct)||0)/100;
    const eqPart = totalEq * pct;
    const qtyTarget = (Number(food.factor)>0) ? (eqPart / Number(food.factor)) : 0;
    resEl.textContent = fmt(qtyTarget);
  });
}

function renderInputs(){
  const cont = $('inputs');
  cont.innerHTML = '';
  state.inputs.forEach((inp, idx)=> {
    const row = document.createElement('div');
    row.className = 'row';

    const sel = makeFoodSelect(state.mode, inp.foodName, (val)=> {
      inp.foodName = val;
      const food = findFood(val);
      inp.unit = unitDefaultFor(food);
      showFoodDetail(food);
      renderAll(false);
    });

    const qty = document.createElement('input');
    qty.type='number'; qty.step='any'; qty.value = inp.qty ?? 0;
    qty.addEventListener('input', ()=>{ inp.qty = qty.value; calc(); });

    const unit = document.createElement('select');
    unit.innerHTML = ['g','g/ml','porzioni','uova','fette','unità'].map(u=>`<option value="${u}" ${u===inp.unit?'selected':''}>${u}</option>`).join('');
    unit.addEventListener('change', ()=>{ inp.unit = unit.value; });
    if (!inp.unit) inp.unit = unit.value;

    const rm = document.createElement('button');
    rm.textContent='✕';
    rm.className='danger';
    rm.addEventListener('click', ()=>{ removeAt(state.inputs, idx); renderAll(); });

    row.appendChild(sel);
    row.appendChild(qty);
    row.appendChild(unit);
    row.appendChild(rm);
    cont.appendChild(row);
  });
}

function renderOutputs(){
  const cont = $('outputs');
  cont.innerHTML = '';
  state.outputs.forEach((out, idx)=> {
    const row = document.createElement('div');
    row.className = 'row outputs';
    row.dataset.outRow = "1";

    const sel = makeFoodSelect(state.mode, out.foodName, (val)=> {
      out.foodName = val;
      showFoodDetail(findFood(val));
      renderAll(false);
    });

    const pct = document.createElement('input');
    pct.type='number'; pct.step='any'; pct.value = out.pct ?? 0;
    pct.addEventListener('input', ()=>{ out.pct = pct.value; calc(); });

    const res = document.createElement('div');
    res.dataset.outRes = "1";
    res.className='pill';
    res.style.justifyContent='center';
    res.textContent='—';

    const rm = document.createElement('button');
    rm.textContent='✕';
    rm.className='danger';
    rm.addEventListener('click', ()=>{ removeAt(state.outputs, idx); renderAll(); });

    row.appendChild(sel);
    row.appendChild(pct);
    row.appendChild(res);
    row.appendChild(rm);

    cont.appendChild(row);
  });
}

function showFoodDetail(food){
  if (!food){
    $('foodDetailName').textContent = '—';
    $('foodDetailBody').textContent = '—';
    return;
  }
  $('foodDetailName').textContent = food.name;
  $('foodDetailBody').innerHTML = `
    <div class="small">Categoria: <span class="mono">${escapeHtml(food.category)}</span></div>
    <div class="small">Unità base: <span class="mono">${escapeHtml(food.base)}</span></div>
    <div class="small">Fattore: <span class="mono">${food.factor}</span></div>
    <div class="small">Unità suggerita: <span class="mono">${escapeHtml(food.unitHint)}</span></div>
    <div class="small">Note: <span class="mono">${escapeHtml(food.note || '—')}</span></div>
  `;
}

function normalizeOutputs(){
  const sum = state.outputs.reduce((s,o)=>s+(Number(o.pct)||0),0);
  if (!sum) return;
  state.outputs = state.outputs.map(o=>({...o, pct: (Number(o.pct)||0) * 100 / sum }));
  renderAll();
}

function renderAll(recalc=true){
  renderInputs();
  renderOutputs();
  if (recalc) calc();
}

function init(){
  renderModeSelect();
  state.inputs = [{ foodName:'', qty:0, unit:'' }];
  state.outputs = [{ foodName:'', pct:100 }];
  $('addInputBtn').addEventListener('click', addInput);
  $('addOutputBtn').addEventListener('click', addOutput);
  $('clearInputsBtn').addEventListener('click', ()=>{ state.inputs=[]; addInput(); });
  $('clearOutputsBtn').addEventListener('click', ()=>{ state.outputs=[]; addOutput(); });
  $('normalizeBtn').addEventListener('click', normalizeOutputs);
  renderAll();
}
init();
</script>
</body>
</html>
